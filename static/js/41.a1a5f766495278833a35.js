webpackJsonp([41,194],{585:function(A,n){A.exports={rawContent:"\n## 愿总有阳光照进回忆里：学生购电用电查询系统\n\n感冒了，难得会被人挂念。谢谢，总有阳光照进回忆里，温暖的气息让人难以忘记。\n\n-------\n\n某天，一位大神师兄 @Zhaoking 神秘兮兮地给我看一个网站 http://ydcx.bupt.edu.cn/\n\n师兄说，你可以试着把它的数据爬下来。\n\n当时开着八个线程跟着机器学习、回归分析、统计推断、探索性图形分析一堆数据分析的课程，觉得似乎把用电数据爬下来可以玩玩。\n于是谨听师兄命令……\n\n![](/images/spider/ydcx.png)\n\n首先，就是研究研究网站逻辑。打开firebug，输入1-101，回车。\n\n![](/images/spider/ydcx1.png)\n\n显然，首先是一个post操作，但返回了一个302重定向，所以，第二个请求应该是正确的请求\n\n试试看看\n\n    In [1]: import requests\n\n    In [2]: dorm_num = '1-101'\n\n    In [3]: r = requests.get('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num)\n\n检查下r.content，确认在里头看到了电量和加电信息。\n\n![](/images/spider/ydcx2.png)\n\n那么，还有这么多页这么办？我们点点看看。页码1已经不能点了，点2。\n\n![](/images/spider/ydcx3.png)\n\n竟然变成一个post了，而且post的数据这么多，你可以抱着试试看的心理不加上这些post的数据试试。\n\n    In [5]: __EVENTTARGET = 'GridView1'\n\n    In [6]: __EVENTARGUMENT = 'Page$2'\n\n    In [7]: data = {'__EVENTTARGET': __EVENTTARGET,  '__EVENTARGUMENT': __EVENTARGUMENT}\n\n    In [9]: r = requests.post('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num, data=data)\n\n    In [10]: r\n    Out[10]: <Response [500]>\n\n500——internal error……这个错误一般表示服务器内部处理出现错误。怎么回事呢，直觉告诉我们，问题就在于那些Post的参数。\n\n加上试试，\n\n     In [15]: data = {'__EVENTTARGET': __EVENTTARGET,  '__EVENTARGUMENT': __EVENTARGUMENT, '__EVENTVALIDATION': '/wEWCwLMxp63CAKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1/Loh35D537/CRr+++EgM74nLP5E=', '__VIEWSTATE': '/wEPDwULLTIwNzMwNzAxOTAPZBYCAgMPZBYQZg8PFgIeBFRleHQFATFkZAIBDw8WAh8ABQEgZGQCAg8PFgIfAAUyMS0xMDEgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZAIDDw8WAh8ABQbnlLXku7dkZAIEDw8WAh8ABQwwMDAwMDAwMzg5NTVkZAIFDw8WAh8ABQ0xMC4yMTAuOTYuMjEwZGQCBg88KwANAQAPFgQeC18hRGF0YUJvdW5kZx4LXyFJdGVtQ291bnQCjQNkFgJmD2QWFgIBD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTI0IDA6MDA6MDBkZAICDw8WAh8ABQMyMTVkZAICD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIzIDA6MDA6MDBkZAICDw8WAh8ABQMyMThkZAIDD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIyIDA6MDA6MDBkZAICDw8WAh8ABQMyMjBkZAIED2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIxIDA6MDA6MDBkZAICDw8WAh8ABQMyMjNkZAIFD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTIwIDA6MDA6MDBkZAICDw8WAh8ABQMyMjVkZAIGD2QWBmYPDxYCHwAFMjEtMTAxICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGQCAQ8PFgIfAAURMjAxNC04LTE5IDA6MDA6MDBkZAICDw8WAh8ABQMyMjhk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'} \n\n    In [16]: r = requests.post('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num, data=data)\n\n    In [17]: r\n    Out[17]: <Response [200]>\n\n\n成功的返回了需要的用电数据，你可以检查下r.content看看\n\n接下来的问题在于，这些参数从哪里来的？\n\n简单谷歌下和检查下网页源代码，可以看到\n\n![](/images/spider/ydcx6.png)\n\n那么逻辑就清晰了，先get请求某个寝室的页面，获取对应的post参数，然后一页一页往后翻就是。\n\n下面讲讲如何从html源码中提取信息，用re当然可以，但是xpath这种东西也许更好用。比如\n\n```python\n## parse the content\nroot = fromstring(r.content)\n## extract __VIEWSTATE\n__VIEWSTATE = root.xpath('//input[@name=\"__VIEWSTATE\"]/@value')[0]\n## extract __EVENTVALIDATION\n__EVENTVALIDATION = root.xpath('//input[@name=\"__EVENTVALIDATION\"]/@value')[0]\n```\n\n相比写这么个正则简单优雅很多，不过所谓quick and dirty，不管黑猫白猫……：\n\n```python\nre.search('id=\"__VIEWSTATE\" value=\"([^\"]+)\", r.content).group(1)\n```\n\n接下来的问题在于，页码总数我不知道，最后的一个...符号可以进入下一个十页。\n\n![](/images/spider/ydcx4.png)\n\n![](/images/spider/ydcx5.png)\n\n那么，反正最后经过trial and error以一种很quick and dirty的方式work around页码这个问题……\n\n我的解决方案，一个循环，页码不断加一，并且读取当前页右下角所有显示页码。\n\n如果当前页面的那些页码cpn中最后一个，比我下一个想要抓取的np页码小一，或者当前页码个数不是十个，就肯定是最后几页了，就可以抓取然后break不继续往后抓取了。\n\nif (int(cpn[-1]) == np - 1) or (int(cpn[-1]) % 10 != 0):\n\n反正……最后可以运行……\n\n![](/images/spider/ydcx7.png)\n\n多么不堪入目的实现，随便看看玩\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\n\"\"\"\n用电信息\nhttp://ydcx.bupt.edu.cn/Default.aspx\n\"\"\"\n\n__author__ = \"Reverland\"\n\nimport socket\nfrom gevent import monkey\nmonkey.patch_all()\nimport requests\nfrom lxml.html import fromstring\nimport re\nimport os\n\ntimeout = 30\nsocket.setdefaulttimeout(timeout)\n\ntry:\n    os.makedirs('data')\nexcept:\n    pass\n\n\ndef buy_info(dorm_num, root):\n    # skip for downloaded\n    if os.path.exists('data/' + dorm_num + '.csv'):\n        print dorm_num + 'buy info downloaded...'\n        return\n    data = root.xpath('//table[@id=\"GridView2\"]/tr/td/font/text()')\n    # header\n    with open('data/' + dorm_num + '_buy.csv', 'wb') as f:\n        f.write('timestamp, electric_increase, money, charge_bool, state, operator\\n')\n    for i in range(len(data)):\n        # timestamp, electric_increase, money, charge_bool, state, operator\n        if i % 7 < 6:\n            with open('data/' + dorm_num + '_buy.csv', 'a') as f:\n                f.write(data[i].encode('iso-8859-1').strip() + ',')\n        if i % 7 == 6:\n            with open('data/' + dorm_num + '_buy.csv', 'a') as f:\n                f.write(data[i].encode('iso-8859-1').strip() + '\\n')\n\n\n\ndef parse_dorm_elec(dorm_num):\n    # skip for downloaded\n    if os.path.exists('data/' + dorm_num + '.csv'):\n        print dorm_num + ' downloaded...'\n        return\n    print \"parsing \" + dorm_num + ' now...'\n    data = []\n    r = requests.get('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num)\n    ## parse the content\n    root = fromstring(r.content)\n    ## extract __VIEWSTATE\n    __VIEWSTATE = root.xpath('//input[@name=\"__VIEWSTATE\"]/@value')[0]\n    ## extract __EVENTVALIDATION\n    __EVENTVALIDATION = root.xpath('//input[@name=\"__EVENTVALIDATION\"]/@value')[0]\n    ## __EVENTTARGET is fixed\n    __EVENTTARGET = 'GridView1'\n    buy_info(dorm_num, root)\n    ## define headers\n    header = {\n    'Content-Type': 'application/x-www-form-urlencoded'\n    }\n    np = 2\n\n    while (1):\n        # First extract some value\n        # print \"Retrieving data from page\", np\n        __EVENTARGUMENT = 'Page$' + str(np)\n        payload = {\n        '__EVENTARGUMENT': __EVENTARGUMENT,\n        '__EVENTTARGET': __EVENTTARGET,\n        '__EVENTVALIDATION': __EVENTVALIDATION,\n        '__VIEWSTATE': __VIEWSTATE}\n        r = requests.post('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num, data=payload, headers=header)\n        ## get electric data\n        data += re.findall('<td align=\"center\"><font color=\"#4A3C8C\">([^<]+)', r.content)\n        ## get current page numbers\n        cpn = re.findall('\\)\"><font color=\"#4A3C8C\">([\\d]+)', r.content)\n        if (int(cpn[-1]) == np - 1) or (int(cpn[-1]) % 10 != 0):\n            cpn = range(np+1, int(cpn[-1]) + 1)\n            ## next page\n            for p in cpn:\n                ## parse the content\n                root = fromstring(r.content)\n                ## extract __VIEWSTATE\n                __VIEWSTATE = root.xpath('//input[@name=\"__VIEWSTATE\"]/@value')[0]\n                ## extract __EVENTVALIDATION\n                __EVENTVALIDATION = root.xpath('//input[@name=\"__EVENTVALIDATION\"]/@value')[0]\n                __EVENTARGUMENT = 'Page$'+ str(p)\n                payload = {\n                '__EVENTARGUMENT': __EVENTARGUMENT,\n                '__EVENTTARGET': __EVENTTARGET,\n                '__EVENTVALIDATION': __EVENTVALIDATION,\n                '__VIEWSTATE': __VIEWSTATE}\n                r = requests.post('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num, data=payload, headers=header)\n                data += re.findall('<td align=\"center\"><font color=\"#4A3C8C\">([^<]+)', r.content)\n                # print \"Retrieving data from page\", p\n            break\n        ## next page\n        for p in cpn:\n            ## parse the content\n            root = fromstring(r.content)\n            ## extract __VIEWSTATE\n            __VIEWSTATE = root.xpath('//input[@name=\"__VIEWSTATE\"]/@value')[0]\n            ## extract __EVENTVALIDATION\n            __EVENTVALIDATION = root.xpath('//input[@name=\"__EVENTVALIDATION\"]/@value')[0]\n            __EVENTARGUMENT = 'Page$' + p\n            payload = {\n            '__EVENTARGUMENT': __EVENTARGUMENT,\n            '__EVENTTARGET': __EVENTTARGET,\n            '__EVENTVALIDATION': __EVENTVALIDATION,\n            '__VIEWSTATE': __VIEWSTATE}\n            r = requests.post('http://ydcx.bupt.edu.cn/see.aspx?useid=' + dorm_num, data=payload, headers=header)\n            data += re.findall('<td align=\"center\"><font color=\"#4A3C8C\">([^<]+)', r.content)\n            # print \"Retrieving data from page\", p\n        # check if reach end\n        np = int(cpn[-1]) + 1\n    # write header\n    with open('data/' + dorm_num + '.csv', 'wb') as f:\n        f.write('timestamp' + ',' + 'electric_remain\\n')\n    for i in range(len(data)):\n        if i % 3 == 1:\n            with open('data/' + dorm_num + '.csv', 'a') as f:\n                f.write(data[i] + ',')\n        if i % 3 == 2:\n            with open('data/' + dorm_num + '.csv', 'a') as f:\n                f.write(data[i] + '\\n')\n    return data\n    ## for example\n    # __EVENTVALIDATION = '/wEWCwKhncT7DwKtsp64BAKtsuK4BAKtsva4BAKtsvq4BAKtsu64BAKtsvK4BAKtssa4BAKtssq4BALDuK6IBQKokYx1vYI/vd4i5UCVuVYMSo/l30x1o/g='\n    # __EVENTARGUMENT = 'Page$2'\n\n#data = parse_dorm_elec(dorm_num)\ndef parse_dorm_elec_wrap(dorm_num):\n    try:\n        parse_dorm_elec(dorm_num)\n    except:\n        print \"parsing \" + dorm_num + \" error...\"\n        pass\n# ----------------------------------------------------\n# # dorm 10\n# dorms = []\n# # layer 1\n# dorms += map(lambda x: '10-1' + str(x).zfill(2), range(1, 17))\n# # layer 2\n# dorms += map(lambda x: '10-2' + str(x).zfill(2), range(1, 21))\n# # layer 3 to 7\n# for l in range(3, 8):\n#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2), range(1, 72))\n# # layer 8 to 13\n# for l in range(8, 14):\n#     dorms += map(lambda x: '10-' + str(l) + str(x).zfill(2) , range(1, 53))\n# ------------------------------------------------------\n\n#--------------------\n# dorm 1\ndorms = []\n# layer 1\ndorms += map(lambda x: '1-' + str(1) + str(x).zfill(2), range(1, 24))\n# layer 2,5\nfor l in range(2, 6):\n    dorms += map(lambda x: '1-' + str(l) + str(x).zfill(2), range(1, 27))\n#--------------------\n\n# for d in dorms:\n#     try:\n#         parse_dorm_elec_wrap(d)\n#     except:\n#         try:\n#             parse_dorm_elec_wrap(d)\n#         except:\n#             print \"Error with \", d\n#             pass\n\nfrom gevent.pool import Pool\npool = Pool(5)\npool.join(timeout=timeout)\npool.map(parse_dorm_elec_wrap, dorms)\n#\n# print dorms\n# parse_dorm_elec('10-1220')\n```\n",metaData:{layout:"post",title:"Python Spider: 北邮用电查询系统数据",excerpt:"速写爬虫的一些经历",category:"python",tags:["python","spider"],disqus:!0}}}});