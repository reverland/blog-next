webpackJsonp([114,177],{309:function(n,t){n.exports={rawContent:"\n\n# python小练习：网络视频下载\n\n互联网上有很多视频网站，提供大量视频。可是大多都要求你使用它提供的专有软件才能下载，或者根本没提供下载的地方。在linux下怎么办？总是有办法的。浏览器扩展,[you-get](https://github.com/soimort/you-get/tree/master/you_get)，直接从硕鼠解析出地址自己下载……\n\n这不是重点，重点是：自己动手玩一玩。\n- 顺便学习下几个python标准库：`urllib`、`urllib2`、`re`。\n- 初步学习http报头知识\nExtra bonus:\n- flv文件结构\n\n都是随便看看。\n\n## 下载视频\n\n简单起见，直接从[硕鼠](http://www.flvcd.com/index.htm)抓取地址。\n\n首先我们随便找一个视频地址，比如来自sina的[憨豆特工](http://video.sina.com.cn/v/b/56925622-2257301331.html)。我们把地址用硕鼠解析出来看看：\n\n![硕鼠](http://fmn.rrfmn.com/fmn058/20121202/2100/original_jaVP_5b4d00008fb1125d.jpg)\n\n哇哦，一个电影被分成15个文件了。\n\n我们接下来要做的就是抓取这十五个视频的地址并把他们下载下来。\n\n也许，用正则是个不错的办法。查看该页面源码，可以找到这样的内容：\n\n    <input type=\"hidden\" name=\"inf\" value=\"<R>憨豆特工\n    <T>0\n    <F>http://video.sina.com.cn/v/b/56925622-2257301331.html\n    <QX>normal\n    <$>\n    <N>憨豆特工-0001\n    <P>新浪网\n    <U>http://edge.v.iask.com/56926940.hlv?KID=sina,viask&Expires=1354550400&ssig=0G8Acouy32\n    <X>0001\n    <C>aHR0cDovL3YuaWFzay5jb20vdl9wbGF5LnBocD92aWQ9NTY5MjU2MjItMjI1NzMwMTMzMSZyPXZpZGVvLnNpbmEuY29tLmNu\n    <EXPLODEID>1\n    <&>\n    <$>\n    <N>憨豆特工-0002\n    <P>新浪网\n    <U>http://edge.v.iask.com/56921791.hlv?KID=sina,viask&Expires=1354550400&ssig=aDBPWf%2B2YH\n    <X>0001\n    <C>aHR0cDovL3YuaWFzay5jb20vdl9wbGF5LnBocD92aWQ9NTY5MjU2MjItMjI1NzMwMTMzMSZyPXZpZGVvLnNpbmEuY29tLmNu\n    <EXPLODEID>2\n    <&>\n    <$>\n    <N>憨豆特工-0003\n    <P>新浪网\n    ......\n\n显然，`<N>`后面是片名而`<U>`后面是地址。\n\n另外，我们观察一下硕鼠当前页面的url地址。\n\n    http://www.flvcd.com/parse.php?kw=http%3A%2F%2Fvideo.sina.com.cn%2Fv%2Fb%2F56925622-2257301331.html\n\n显然，kw参数后面是之前sina视频页面地址，只不过已经经过转码处理。\n\n至此，足够我们用python来完成这一切了。\n\n打开ipython：\n\n    In [1]: import urllib\n    \n    In [2]: import urllib2\n    \n    In [3]: videourl = 'http://video.sina.com.cn/v/b/56925622-2257301331.html' \n    \n    In [4]: url = 'http://www.flvcd.com/parse.php?kw=' + urllib.quote(videourl)\n    \n    In [5]: req = urllib2.Request(url);\n    \n    In [6]: req.add_header('host', 'www.flvcd.com');\n    \n    In [7]: res = urllib2.urlopen(req)\n    \n    In [8]: html = res.read()\n    \n    In [9]: print unicode(html,'gbk') # 注意硕鼠的页面编码是charset=GB2312\n\n至此，我们完成了从硕鼠读取整个网页的操作。并把读取的内容保存在html中。\n\n接下来开始抓地址，根据之前的观察，很容易通过正则表达式完成：\n\n    In [13]: import re\n    \n    In [14]: pattern = re.compile('<input\\s+type=\"hidden\"\\s+name=\"inf\"\\s+value=\"([^\"]+)')\n    \n    In [15]: match = pattern.search(html)\n    \n    In [16]: urls = match.group(1)\n    \n    In [17]: urls = unicode(urls, 'gbk')\n    \n    In [18]: urlpattern = re.compile('<[NU]>(.+)')\n    \n    In [19]: result = urlpattern.findall(urls)\n\n至此，`<N>`和`<U>`后面的文件名和地址都被以列表的形式保存在result中了。我们可以遍历它来完成下载：\n\n先简单处理下，以文件名-地址成对保存：\n\n    In [28]: data = [result[i:i+2] for i in range(0, len(result), 2)]\n\n然后遍历下载：\n\n    In [32]: for k, v in enumerate(data):                   \n        print '  >downloading Block %.2d ...' % (k+1,) \n        urllib.urlretrieve(v[1], v[0] + '.flv') \n        print '  downloaded Block.%.2d completely<' % (k+1,)\n\n然后？等着……目前的下载器相当简陋，木有进度条，木有断点……\n\n之后就是合并flv的问题了。\n\n## 合并flv文件\n\n简单起见，直接用这里[join\\_flv.py](https://github.com/soimort/you-get/blob/master/you_get/processor/join_flv.py)来完成。\n\n    python2 join_flv.py -o out.flv flv1.flv flv2.flv ...\n\n如果你想深入了解flv文件结构，参考further reading部分和flv文件[规范](http://download.macromedia.com/f4v/video_file_format_spec_v10_1.pdf)。\n\n![flash-data](http://fmn.rrimg.com/fmn062/20121203/1830/original_yzzH_5943000093b01191.jpg)\n\n## Practice\n\n抓取这里的视频。并按名称保存他们:\n \n- [https://class.coursera.org/ml/lecture/preview](https://class.coursera.org/ml/lecture/preview)\n- [http://v.163.com/special/opencourse/machinelearning.html](http://v.163.com/special/opencourse/machinelearning.html)\n\n作为正则和urllib、urllib2的练习。\n\n## Further Reading\n\n- [在线视频下载(Using Python / Bash / C / Reguar Expressions)](http://www.cnblogs.com/-Wind/archive/2012/01/30/dov.html)\n- [flv文件详解](https://www.oschina.net/code/snippet_107925_16025)\n- [FLV文件格式解析](http://blog.sina.com.cn/s/blog_48f93b530100eyoe.html)\n- [you-get](https://github.com/soimort/you-get/blob/master/you_get/processor/join_flv.py)\n",metaData:{layout:"post",title:"python小练习：网络视频下载",excerpt:"",category:"python",tags:["python"],disqus:!0}}}});